---
import { Image } from 'astro:assets';
import { Github, Feather } from 'lucide-astro';
import X from '@components/icons/X.astro';
import { getDonorAvatar } from '@utils/donorImages';

interface Props {
    donor: {
        id: string;
        displayName: string;
        avatarUrl?: string;
        image?: string;
        message?: string;
        links?: {
            twitter?: string;
            nostr?: string;
            github?: string;
        };
        badges?: string[];
        blockHeight?: number;
        rank?: number;
    };
    index?: number;
    showMessage?: boolean;
    showSocials?: boolean;
    showBlockHeight?: boolean;
}

const { 
    donor, 
    index = 0,
    showMessage = true,
    showSocials = true,
    showBlockHeight = true
} = Astro.props;

const avatarSrc = getDonorAvatar(donor.image);

// Get first available link in priority order: twitter → nostr → github
const getPrimaryLink = () => {
    if (!donor.links) return null;
    
    if (donor.links.twitter) {
        return `https://x.com/${donor.links.twitter}`;
    }
    if (donor.links.nostr) {
        return `https://njump.me/${donor.links.nostr}`;
    }
    if (donor.links.github) {
        return `https://github.com/${donor.links.github}`;
    }
    
    return null;
};

const primaryLink = getPrimaryLink();
---

<div
    class="flex flex-col group text-center items-center"
    data-aos="fade-up"
    data-aos-delay={index * 100}
    data-aos-duration="800"
>
    <div class="relative mb-4 overflow-hidden rounded-lg w-full max-w-[200px]">
        <span class="absolute inset-0 -mt-12 h-400 w-1/2 translate-x-[250%] rotate-12 bg-white opacity-20 group-hover:transition-all group-hover:duration-300 ease-out group-hover:translate-x-[-250%] z-10" />
        {primaryLink ? (
            <a
                href={primaryLink}
                target="_blank"
                rel="noopener noreferrer"
                aria-label={`Visit ${donor.displayName}'s profile`}
            >
                <Image
                    src={avatarSrc}
                    alt={donor.displayName}
                    width={400}
                    height={400}
                    quality={80}
                    format="webp"
                    class="w-full h-auto aspect-square object-cover rounded-lg transition-all duration-500 ease-in-out"
                    loading="lazy"
                    decoding="async"
                />
            </a>
        ) : (
            <Image
                src={avatarSrc}
                alt={donor.displayName}
                width={400}
                height={400}
                quality={80}
                format="webp"
                class="w-full h-auto aspect-square object-cover rounded-lg transition-all duration-500 ease-in-out"
                loading="lazy"
                decoding="async"
            />
        )}
    </div>
    
    <div class="flex flex-col space-y-3 items-center">
        <div>
            <h3 class="text-lg font-semibold text-headline transition-colors duration-300 group-hover:text-primary">
                {donor.displayName}
            </h3>
            {showMessage && donor.message && (
                <p class="text-sm text-body-base opacity-80 italic mt-1">
                    "{donor.message}"
                </p>
            )}
        </div>

        {/* Social Links */}
        {showSocials && donor.links && (Object.keys(donor.links).length > 0) && (
            <div class="flex items-center justify-center gap-3">
                {donor.links.twitter && (
                    <a
                        href={`https://x.com/${donor.links.twitter}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-body-base hover:text-primary transition-colors"
                        aria-label={`${donor.displayName} on X/Twitter`}
                    >
                        <X size={16} />
                    </a>
                )}
                {donor.links.nostr && (
                    <a
                        href={`https://njump.me/${donor.links.nostr}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-body-base hover:text-primary transition-colors"
                        aria-label={`${donor.displayName} on Nostr`}
                    >
                        <Feather size={16} strokeWidth={1.5} />
                    </a>
                )}
                {donor.links.github && (
                    <a
                        href={`https://github.com/${donor.links.github}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-body-base hover:text-primary transition-colors"
                        aria-label={`${donor.displayName} on GitHub`}
                    >
                        <Github size={16} strokeWidth={1.5} />
                    </a>
                )}
            </div>
        )}

        {/* Badges */}
        {donor.badges && donor.badges.includes('100k-sats') && (
            <div class="flex items-center justify-center gap-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary border border-primary/20">
                    100k sats
                </span>
            </div>
        )}

        {/* Optional Block Height */}
        {showBlockHeight && donor.blockHeight && (
            <p class="text-xs text-body-base opacity-60">
                Added at block {donor.blockHeight.toLocaleString()}
            </p>
        )}
    </div>
</div>



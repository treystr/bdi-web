---
import Button from '@components/ui/Button.astro';
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Badge {
    text: string;
    color?: 'primary' | 'accent' | 'success' | 'warning';
}

interface ProgressData {
    goalAmount: number;
    currentAmount: number;
}

interface Props {
    // Core props
    title: string;
    description: string;
    imageSrc: string | ImageMetadata;
    imageAlt?: string;
    
    // Navigation
    href?: string;
    externalLink?: string; // For external links (e.g., business websites)
    
    // Styling variants
    variant?: 'standard' | 'featured';
    
    // Badge overlay
    badge?: Badge;
    
    // Button controls
    showButton?: boolean;
    buttonText?: string;
    
    // Date display
    date?: string;
    showDate?: boolean;
    targetDate?: string;
    showTargetDate?: boolean;
    
    // Featured card extras
    progressData?: ProgressData;
    
    // Business onboarding specific
    number?: number; // Sequential number for business cards
    blockHeight?: number; // Bitcoin block height
}

const {
    title,
    description,
    imageSrc,
    imageAlt,
    href,
    externalLink,
    variant = 'standard',
    badge,
    showButton = true,
    buttonText = 'Learn More',
    date,
    showDate = false,
    targetDate,
    showTargetDate = false,
    progressData,
    number,
    blockHeight,
} = Astro.props;

// Format dates
const formattedDate = date && showDate
    ? new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(date))
    : null;

const formattedTargetDate = targetDate && showTargetDate
    ? new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long' }).format(new Date(targetDate))
    : null;

// Calculate progress percentage for featured cards
const progressPercent = progressData && progressData.goalAmount > 0
    ? Math.round((progressData.currentAmount / progressData.goalAmount) * 100)
    : 0;

// Format block height
const formattedBlockHeight = typeof blockHeight === 'number' ? blockHeight.toString() : null;

// Determine badge color class
const badgeColorClass = badge?.color === 'accent' ? 'badge-accent'
    : badge?.color === 'success' ? 'badge-success'
    : badge?.color === 'warning' ? 'badge-warning'
    : 'badge-primary';

// Resolve alt text
const resolvedAlt = imageAlt || title;

// Determine the link to use (href takes precedence over externalLink)
const cardLink = href || externalLink;
const isExternalLink = !href && !!externalLink;
---

<article class:list={['initiative-card', { 'initiative-card--featured': variant === 'featured' }]} data-aos="fade-up">
    <!-- Card Image -->
    <div class="card-image-wrapper">
        {cardLink ? (
            <a href={cardLink} class="card-image-link" target={isExternalLink ? '_blank' : '_self'} rel={isExternalLink ? 'noopener noreferrer' : undefined}>
                <div class="card-image">
                    {typeof imageSrc === 'string' ? (
                        <img src={imageSrc} alt={resolvedAlt} loading="lazy" />
                    ) : (
                        <Image src={imageSrc} alt={resolvedAlt} loading="lazy" class="image-component" />
                    )}
                </div>
            </a>
        ) : (
            <div class="card-image">
                {typeof imageSrc === 'string' ? (
                    <img src={imageSrc} alt={resolvedAlt} loading="lazy" />
                ) : (
                    <Image src={imageSrc} alt={resolvedAlt} loading="lazy" class="image-component" />
                )}
            </div>
        )}
        
        <!-- Badge Overlay -->
        {badge && (
            <div class:list={['card-badge', badgeColorClass]}>
                {badge.text}
            </div>
        )}
    </div>

    <!-- Card Content -->
    <div class="card-content">
        <!-- Number (for business cards) -->
        {typeof number !== 'undefined' && (
            <div class="card-number">{number}</div>
        )}
        
        <!-- Title -->
        <h3 class="card-title">
            {cardLink ? (
                <a href={cardLink} class="card-title-link" target={isExternalLink ? '_blank' : '_self'} rel={isExternalLink ? 'noopener noreferrer' : undefined}>
                    {title}
                    {isExternalLink && (
                        <svg class="external-link-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                    )}
                </a>
            ) : (
                <span>{title}</span>
            )}
        </h3>

        <!-- Date Info -->
        {(formattedDate || formattedTargetDate || formattedBlockHeight) && (
            <div class="card-dates">
                {formattedDate && (
                    <time datetime={date} class="card-date">
                        {formattedDate}
                    </time>
                )}
                {formattedTargetDate && (
                    <div class="card-target-date">
                        <svg class="icon-calendar" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>Target: {formattedTargetDate}</span>
                    </div>
                )}
                {formattedBlockHeight && (
                    <div class="card-block-height">
                        Block #{formattedBlockHeight}
                    </div>
                )}
            </div>
        )}

        <!-- Description -->
        <p class="card-description">
            {description}
        </p>

        <!-- Progress Bar (Featured variant only) -->
        {variant === 'featured' && progressData && progressData.goalAmount > 0 && (
            <div class="card-progress">
                <div class="progress-labels">
                    <span class="progress-label">Funding Progress</span>
                    <span class="progress-amount">
                        ${progressData.currentAmount.toLocaleString()} / ${progressData.goalAmount.toLocaleString()}
                    </span>
                </div>
                <div class="progress-bar-container">
                    <div 
                        class="progress-bar-fill"
                        style={`width: ${progressPercent}%`}
                    />
                </div>
                <p class="progress-percent">
                    {progressPercent}% funded
                </p>
            </div>
        )}

        <!-- Button -->
        {showButton && href && (
            <div class="card-button-wrapper">
                <Button href={href} variant="primary" size="md">
                    {buttonText}
                    <svg class="button-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
                    </svg>
                </Button>
            </div>
        )}
        
        {/* Note: For external links (business cards), typically no button is shown */}
    </div>
</article>

<style>
    .initiative-card {
        border: 1px solid rgba(var(--color-body-base-rgb), 0.1);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        background: var(--color-base);
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .initiative-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
        border-color: rgba(var(--color-accent-rgb), 0.3);
    }

    /* Featured variant styling */
    .initiative-card--featured {
        border-color: rgba(var(--color-accent-rgb), 0.2);
    }

    .initiative-card--featured:hover {
        border-color: rgba(var(--color-accent-rgb), 0.5);
    }

    /* Card Image */
    .card-image-wrapper {
        position: relative;
        flex-shrink: 0;
    }

    .card-image-link {
        display: block;
    }

    .card-image {
        aspect-ratio: 3 / 2;
        overflow: hidden;
        position: relative;
    }

    .card-image img,
    .card-image :global(.image-component) {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.3s ease;
    }

    .initiative-card:hover .card-image img,
    .initiative-card:hover .card-image :global(.image-component) {
        transform: scale(1.05);
    }

    /* Badge Overlay */
    .card-badge {
        position: absolute;
        top: 1rem;
        left: 1rem;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 700;
        border-radius: 9999px;
        line-height: 1.2;
        z-index: 10;
    }

    .badge-primary {
        background: rgba(var(--color-primary-rgb), 0.9);
        color: white;
    }

    .badge-accent {
        background: rgba(var(--color-accent-rgb), 0.9);
        color: white;
    }

    .badge-success {
        background: rgba(16, 185, 129, 0.9);
        color: white;
    }

    .badge-warning {
        background: rgba(245, 158, 11, 0.9);
        color: white;
    }

    /* Card Content */
    .card-content {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        flex: 1;
    }

    /* Number (for business cards) */
    .card-number {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--color-accent);
        text-align: center;
        background: rgba(var(--color-accent-rgb), 0.1);
        border-radius: 8px;
        padding: 0.5rem;
        width: fit-content;
        min-width: 3rem;
        margin-bottom: 0.5rem;
    }

    /* Title */
    .card-title {
        font-size: 1.375rem;
        font-weight: 700;
        margin: 0;
        line-height: 1.3;
        color: var(--color-accent);
    }

    .card-title-link {
        color: inherit;
        text-decoration: none;
        transition: color 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-title-link:hover {
        color: var(--color-primary);
    }

    .external-link-icon {
        flex-shrink: 0;
        opacity: 0.6;
        transition: opacity 0.2s ease;
    }

    .card-title-link:hover .external-link-icon {
        opacity: 1;
    }

    /* Dates */
    .card-dates {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .card-date {
        font-weight: 600;
        color: var(--color-accent);
    }

    .card-target-date {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        color: rgba(var(--color-body-base-rgb), 0.7);
    }

    .icon-calendar {
        flex-shrink: 0;
    }

    .card-block-height {
        font-size: 0.75rem;
        color: rgba(var(--color-body-base-rgb), 0.6);
        font-family: monospace;
        background: rgba(var(--color-body-base-rgb), 0.05);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        width: fit-content;
    }

    /* Description */
    .card-description {
        font-size: 0.9375rem;
        line-height: 1.6;
        color: rgba(var(--color-body-base-rgb), 0.8);
        margin: 0;
        flex: 1;
    }

    /* Progress Bar (Featured cards) */
    .card-progress {
        margin-top: 0.5rem;
    }

    .progress-labels {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        gap: 1rem;
    }

    .progress-label {
        font-weight: 600;
        color: var(--color-body-base);
    }

    .progress-amount {
        color: rgba(var(--color-body-base-rgb), 0.7);
        font-size: 0.8125rem;
    }

    .progress-bar-container {
        width: 100%;
        background: rgba(var(--color-body-base-rgb), 0.1);
        border-radius: 9999px;
        height: 0.75rem;
        overflow: hidden;
    }

    .progress-bar-fill {
        background: var(--color-accent);
        height: 100%;
        border-radius: 9999px;
        transition: width 0.5s ease;
    }

    .progress-percent {
        font-size: 0.75rem;
        color: rgba(var(--color-body-base-rgb), 0.6);
        margin: 0.375rem 0 0;
    }

    /* Button */
    .card-button-wrapper {
        margin-top: auto;
        padding-top: 0.5rem;
    }

    .button-arrow {
        display: inline-block;
        margin-left: 0.25rem;
        transition: transform 0.2s ease;
    }

    .card-button-wrapper :global(a:hover) .button-arrow {
        transform: translateX(2px);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .card-content {
            padding: 1.25rem;
        }

        .card-number {
            font-size: 1.25rem;
            min-width: 2.5rem;
            padding: 0.375rem;
        }

        .card-title {
            font-size: 1.25rem;
        }

        .card-badge {
            top: 0.75rem;
            left: 0.75rem;
            padding: 0.25rem 0.625rem;
            font-size: 0.6875rem;
        }
    }
</style>

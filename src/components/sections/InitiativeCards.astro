---
import Eyebrow from '@components/ui/Eyebrow.astro';
import InitiativeCard from '@components/initiatives/InitiativeCard.astro';
import { getPaddingClass, getBackgroundColor, getTextColor } from '@utils/styleUtils';
import type { PaddingSize, ThemeColor } from '@utils/styleUtils';
import { getCollection } from 'astro:content';

interface Content {
    eyebrow?: string;
    headline?: string;
    description?: string;
}

export interface Props {
    content?: Content;
    // Layout props
    background?: ThemeColor;
    paddingTop?: PaddingSize;
    paddingBottom?: PaddingSize;
    padding?: PaddingSize;
    // Display options
    maxCards?: number;
    showFeaturedOnly?: boolean;
    statusFilter?: 'active' | 'completed' | 'planned' | 'all';
    sortBy?: 'featured' | 'date' | 'status';
    // Card element visibility
    showBadges?: boolean;
    showDates?: boolean;
    showProgress?: boolean;
    showButtons?: boolean;
}

const {
    content,
    // Layout props
    background = 'base',
    paddingTop,
    paddingBottom,
    padding,
    // Display options
    maxCards,
    showFeaturedOnly = false,
    statusFilter = 'active',
    sortBy = 'featured',
    // Card element visibility
    showBadges = false,
    showDates = false,
    showProgress = false,
    showButtons = true,
} = Astro.props;

const { eyebrow, headline, description } = content || {};

// Get initiatives from content collection
const initiativesEntries = await getCollection('initiatives');

// Filter by status
let filteredInitiatives = statusFilter === 'all' 
    ? initiativesEntries 
    : initiativesEntries.filter(entry => entry.data.status === statusFilter);

// Optionally filter for featured only
if (showFeaturedOnly) {
    filteredInitiatives = filteredInitiatives.filter(entry => entry.data.featured);
}

// Sort initiatives
const sortedInitiatives = [...filteredInitiatives].sort((a, b) => {
    if (sortBy === 'featured') {
        // Featured first, then by start date (newest first)
        if (a.data.featured && !b.data.featured) return -1;
        if (!a.data.featured && b.data.featured) return 1;
        const aDate = new Date(a.data.startDate).getTime();
        const bDate = new Date(b.data.startDate).getTime();
        return bDate - aDate;
    } else if (sortBy === 'date') {
        // Sort by start date (newest first)
        const aDate = new Date(a.data.startDate).getTime();
        const bDate = new Date(b.data.startDate).getTime();
        return bDate - aDate;
    } else if (sortBy === 'status') {
        // Sort by status then date
        const statusOrder = { active: 0, planned: 1, completed: 2 };
        const aStatus = statusOrder[a.data.status];
        const bStatus = statusOrder[b.data.status];
        if (aStatus !== bStatus) return aStatus - bStatus;
        const aDate = new Date(a.data.startDate).getTime();
        const bDate = new Date(b.data.startDate).getTime();
        return bDate - aDate;
    }
    return 0;
});

// Limit number of cards if specified
const displayedInitiatives = maxCards && maxCards > 0 
    ? sortedInitiatives.slice(0, maxCards) 
    : sortedInitiatives;

const paddingClass = getPaddingClass({ padding, paddingTop, paddingBottom });
const bgColor = getBackgroundColor(background);
const textColor = getTextColor(background);

// Helper to determine badge for each initiative
function getBadge(initiative: any) {
    if (initiative.data.featured) {
        return { text: 'Featured Initiative', color: 'accent' as const };
    }
    if (initiative.data.status === 'completed') {
        return { text: 'Completed', color: 'success' as const };
    }
    if (initiative.data.status === 'planned') {
        return { text: 'Coming Soon', color: 'warning' as const };
    }
    if (initiative.data.status === 'active') {
        return { text: 'Active', color: 'primary' as const };
    }
    return undefined;
}
---

<section class:list={['relative', bgColor, paddingClass]}>
    <div class="container mx-auto px-4">
        <!-- Header Content -->
        {(eyebrow || headline || description) && (
            <div class="text-center mb-12 md:mb-16">
                {eyebrow && (
                    <Eyebrow 
                        text={eyebrow} 
                        background={background} 
                    />
                )}
                {headline && (
                    <h2 class:list={['text-3xl md:text-4xl lg:text-5xl font-bold mb-6', textColor]}>
                        {headline}
                    </h2>
                )}
                {description && (
                    <p class:list={['text-lg md:text-xl leading-relaxed max-w-3xl mx-auto', textColor, 'opacity-90']}>
                        {description}
                    </p>
                )}
            </div>
        )}

        <!-- Initiative Cards Grid -->
        {displayedInitiatives.length > 0 ? (
            <div class="grid gap-8 md:grid-cols-2 lg:gap-12">
                {displayedInitiatives.map((entry) => {
                    const badge = showBadges ? getBadge(entry) : undefined;
                    const variant = entry.data.featured ? 'featured' : 'standard';
                    
                    return (
                        <InitiativeCard
                            title={entry.data.title}
                            description={entry.data.shortDescription}
                            imageSrc={entry.data.cardImage}
                            imageAlt={`${entry.data.title} initiative`}
                            href={`/initiatives/${entry.id}`}
                            variant={variant}
                            badge={badge}
                            showButton={showButtons}
                            showTargetDate={showDates && !!entry.data.targetDate}
                            targetDate={entry.data.targetDate ? String(entry.data.targetDate) : undefined}
                            progressData={showProgress && entry.data.goalAmount > 0 ? {
                                goalAmount: entry.data.goalAmount,
                                currentAmount: entry.data.currentAmount
                            } : undefined}
                        />
                    );
                })}
            </div>
        ) : (
            <!-- Empty State -->
            <div class="text-center py-16">
                <div class="max-w-md mx-auto">
                    <div class="w-16 h-16 bg-body-base/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-body-base/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                    </div>
                    <h3 class:list={['text-xl font-semibold mb-2', textColor]}>
                        No {statusFilter === 'all' ? '' : statusFilter.charAt(0).toUpperCase() + statusFilter.slice(1)} Initiatives
                    </h3>
                    <p class:list={['text-body-base/70']}>
                        We're currently planning new initiatives. Check back soon!
                    </p>
                </div>
            </div>
        )}
    </div>
</section>

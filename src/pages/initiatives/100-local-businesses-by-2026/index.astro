---
import { getEntry, render } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import PageHeader from '@components/sections/PageHeader.astro';
import CtaBanner from '@components/sections/CtaBanner.astro';
import InitiativeCardsGrid from '@components/initiatives/InitiativeCardsGrid.astro';
import merchantsData from '@data/merchants.json';

// Get the initiative entry
const entry = await getEntry('initiatives', '100-local-businesses-by-2026');
if (!entry) {
    return Astro.redirect('/404');
}

const { Content } = await render(entry);

// Use SEO data from frontmatter if available
const seoTitle = entry.data.seo?.title || entry.data.title;
const seoDescription = entry.data.seo?.description || entry.data.shortDescription;

// Page header content
const pageHeaderContent = {
    title: entry.data.title,
    description: entry.data.shortDescription,
    progress: {
        current: merchantsData.length,
        goal: 100,
        label: "Merchants Onboarded"
    }
};

// Donate CTA
const donateCta = {
    eyebrow: "SUPPORT THIS INITIATIVE",
    title: `Help Us Achieve: ${entry.data.title}`,
    description: "Your donation directly funds this program and helps us create lasting impact in DC communities. Every contribution, big or small, makes a difference.",
    buttons: [
        {
            text: "Donate Now",
            link: "/donate",
            variant: "primary" as const
        },
        {
            text: "Contact Us",
            link: "/contact",
            variant: "secondary" as const
        }
    ]
};
---

<Layout title={seoTitle} description={seoDescription}>
    <PageHeader 
        title={pageHeaderContent.title} 
        description={pageHeaderContent.description} 
        background="base"
        progress={pageHeaderContent.progress}
    />

    {/* Main Content */}
    <article class="site-container--article mx-auto px-4 prose prose-lg mt-8 mb-16">
        <Content />
    </article>

    {/* Initiative Cards Grid */}
    <InitiativeCardsGrid background="light" />

    {/* Donate CTA */}
    <CtaBanner
        content={donateCta}
        variant="contained"
        background="dark"
        padding="large"
    />

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const copyBtn = document.getElementById('copy-link-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', async () => {
                    const link = copyBtn.getAttribute('data-link');
                    if (link) {
                        try {
                            await navigator.clipboard.writeText(link);
                            const originalText = copyBtn.textContent;
                            copyBtn.textContent = 'Copied!';
                            setTimeout(() => {
                                copyBtn.textContent = originalText;
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy:', err);
                        }
                    }
                });
            }
        });
    </script>
</Layout>


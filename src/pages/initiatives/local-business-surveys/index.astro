---
import { getEntry, render } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import FullScreenHero from '@components/sections/FullScreenHero.astro';
import CtaBanner from '@components/sections/CtaBanner.astro';
import BarChart from '@components/charts/BarChart.astro';
import PieChart from '@components/charts/PieChart.astro';
import heroImage from "@assets/images/hero/hero7.jpg"

// Get the initiative entry
const entry = await getEntry('initiatives', 'local-business-surveys');
if (!entry) {
    return Astro.redirect('/404');
}

const { Content } = await render(entry);

// Fetch survey data from GitHub
let surveyData = null;
let surveyError = null;
let surveyCount = 18; // Fallback count

try {
    const response = await fetch('https://raw.githubusercontent.com/treystr/bdi-data/main/survey/results.json');
    if (response.ok) {
        const data = await response.json();
        surveyData = data.data;
        // Calculate total survey count from the data
        if (surveyData && surveyData.length > 0) {
            const firstQuestion = surveyData[0];
            if (firstQuestion && firstQuestion.data) {
                surveyCount = firstQuestion.data.reduce((total: number, item: any) => total + item.count, 0);
            }
        }
    } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
} catch (error) {
    console.error('Error fetching survey data:', error);
    surveyError = error instanceof Error ? error.message : 'Unknown error occurred';
}

const surveyGoal = 50;

// Use SEO data from frontmatter if available
const seoTitle = entry.data.seo?.title || entry.data.title;
const seoDescription = entry.data.seo?.description || entry.data.shortDescription;

// Hero content
const heroContent = {
    title: entry.data.title,
    backgroundImage: heroImage,
    description: entry.data.shortDescription,
    overlayOpacity: entry.data.hero?.overlayOpacity || 0.7,
    contentPosition: 'center' as const,
    textAlign: 'center' as const,
    ...(entry.data.hero?.image && { backgroundImage: entry.data.hero.image }),
    buttons: [],
    simpleStatsContent: {
        count: surveyCount,
        goal: surveyGoal,
        label: "Surveys Completed"
    }
};

// Get Involved CTA
const getInvolvedCta = {
    eyebrow: "JOIN OUR MISSION",
    title: `Help Us Achieve: ${entry.data.title}`,
    description: "Are you interested in supporting Bitcoin education for DC local businesses? Join our volunteer team conducting door-to-door surveys and building relationships with local business owners.",
};

// Status badge styling
const statusStyles = {
    active: 'bg-green-100 text-green-800',
    completed: 'bg-blue-100 text-blue-800',
    planned: 'bg-yellow-100 text-yellow-800',
};
---

<Layout title={seoTitle} description={seoDescription} fullscreenHero={true}>
    <FullScreenHero content={heroContent} />

    {/* Main Content */}
    <article class="site-container--article mx-auto px-4 prose prose-lg mt-8 mb-16">
        <Content />
    </article>

    {/* Survey Results Charts Section */}
    {surveyData && (
        <section id="survey-results" class="py-16 hidden" data-survey-results-section>
            <div class="site-container--content px-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold mb-4">Survey Results</h2>
                        <p class="text-lg text-body-muted mb-2">
                            Insights from local businesses surveyed across the greater DC metropolitan area
                        </p>
                        <p class="text-sm text-body-muted">
                            Data updated daily from our ongoing field research
                        </p>
                    </div>

                    <div class="grid lg:grid-cols-2 gap-8">
                        {/* Payment Issues - Bar Chart */}
                        {surveyData[0] && (
                            <BarChart
                                id="payment-issues-chart"
                                title={surveyData[0].question}
                                data={surveyData[0].data}
                            />
                        )}

                        {/* Business Investment - Bar Chart */}
                        {surveyData[1] && (
                            <BarChart
                                id="business-investment-chart"
                                title={surveyData[1].question}
                                data={surveyData[1].data}
                            />
                        )}

                        {/* Bitcoin Familiarity - Pie Chart */}
                        {surveyData[2] && (
                            <PieChart
                                id="bitcoin-familiarity-chart"
                                title={surveyData[2].question}
                                data={surveyData[2].data}
                            />
                        )}

                        {/* Thought About Accepting - Pie Chart */}
                        {surveyData[3] && (
                            <PieChart
                                id="thought-about-accepting-chart"
                                title={surveyData[3].question}
                                data={surveyData[3].data}
                            />
                        )}

                        {/* Increase Adoption - Bar Chart */}
                        {surveyData[4] && (
                            <BarChart
                                id="increase-adoption-chart"
                                title={surveyData[4].question}
                                data={surveyData[4].data}
                            />
                        )}

                        {/* Follow Up - Pie Chart */}
                        {surveyData[5] && (
                            <PieChart
                                id="follow-up-chart"
                                title={surveyData[5].question}
                                data={surveyData[5].data}
                            />
                        )}
                    </div>

                    {/* Data Source Info */}
                    <div class="mt-12 text-center">
                        <div class="bg-gray-50 rounded-lg p-6 max-w-2xl mx-auto">
                            <h3 class="text-lg font-semibold text-body-base mb-2">
                                About This Data
                            </h3>
                            <p class="text-sm text-body-base/70 leading-relaxed">
                                These results represent responses from local DC businesses surveyed by our volunteer team. 
                                Data is updated daily as we continue our outreach efforts across the district.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    )}

    {/* Error State for Survey Data */}
    {surveyError && (
        <section class="py-16">
            <div class="site-container--content px-8">
                <div class="max-w-4xl mx-auto text-center">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-2">
                            Survey Data Temporarily Unavailable
                        </h3>
                        <p class="text-sm text-yellow-700">
                            We're having trouble loading the latest survey results. Please check back later.
                        </p>
                    </div>
                </div>
            </div>
        </section>
    )}

        {/* Survey Information Section */}
        <section class="py-16 bg-body-base/5">
            <div class="site-container--content px-8">
                <div class="max-w-4xl mx-auto text-center">
                    <h2 class="text-3xl font-bold mb-4">Printable Field Survey</h2>
                    <p class="text-lg text-body-muted mb-8">
                        This is our printable field survey we take with us when we get out into the city and strike up conversations with local businesses.
                    </p>
                    
                    {/* Survey Image */}
                    <div class="mb-8">
                        <img 
                            src="/media/onboarding/smb_survey.jpg" 
                            alt="Bitcoin District Initiative Local Business Survey Form"
                            class="w-full max-w-lg mx-auto rounded-lg shadow-lg bg-white p-4"
                            loading="lazy"
                        />
                    </div>
    

                </div>
            </div>
        </section>

    {/* Eye Icon Toggle - Bottom of Page */}
    <div class="fixed bottom-6 right-6 z-50">
        <button 
            id="eye-toggle-btn" 
            class="w-12 h-12 bg-gray-800/80 hover:bg-gray-700/90 text-white rounded-full flex items-center justify-center transition-all duration-300 hover:scale-110 shadow-lg backdrop-blur-sm"
            title="Toggle Survey Results"
        >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
        </button>
    </div>

</Layout>

<script>
    // Smooth scrolling for anchor links and Eye toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Add smooth scrolling to all anchor links that start with #
        const anchorLinks = document.querySelectorAll('a[href^="#"]');
        
        anchorLinks.forEach(link => {
            link.addEventListener('click', function(e: Event) {
                e.preventDefault();
                
                const target = e.currentTarget as HTMLAnchorElement;
                const targetId = target.getAttribute('href');
                const targetElement = targetId ? document.querySelector(targetId) : null;
                
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Eye toggle functionality
        const eyeToggleBtn = document.getElementById('eye-toggle-btn') as HTMLButtonElement;
        const surveyResultsSection = document.querySelector('[data-survey-results-section]') as HTMLElement;
        
        if (eyeToggleBtn && surveyResultsSection) {
            let resultsVisible = false;
            
            eyeToggleBtn.addEventListener('click', function() {
                if (resultsVisible) {
                    // Hide results
                    surveyResultsSection.style.opacity = '0';
                    surveyResultsSection.style.transform = 'translateY(-20px)';
                    setTimeout(() => {
                        surveyResultsSection.classList.add('hidden');
                    }, 300);
                    resultsVisible = false;
                } else {
                    // Show results
                    surveyResultsSection.classList.remove('hidden');
                    surveyResultsSection.style.opacity = '0';
                    surveyResultsSection.style.transform = 'translateY(20px)';
                    surveyResultsSection.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                    
                    setTimeout(() => {
                        surveyResultsSection.style.opacity = '1';
                        surveyResultsSection.style.transform = 'translateY(0)';
                    }, 50);
                    
                    resultsVisible = true;
                    
                    // Scroll to results
                    setTimeout(() => {
                        surveyResultsSection.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }, 300);
                }
            });
        }
    });
</script>

